<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Agendar Consulta - Sistema de Sa√∫de</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styleAgen.css">
</head>

<body>
    <!-- Overlay para fechar menu no mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="d-flex flex-column flex-shrink-0 p-3 h-100">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <img src="img/69d6a5f4-d1b9-46db-9b8e-775865f8964f.png" alt="Logo" height="50" class="me-2">
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link" aria-current="page">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="agendamento2.html" class="nav-link active">
                        <i class="fas fa-calendar-check"></i>
                        <span>Agendar Consulta</span>
                    </a>
                </li>
                <li>
                    <a href="consulta.html" class="nav-link">
                        <i class="fas fa-pills"></i>
                        <span>Medicamentos</span>
                    </a>
                </li>
                <li>
                    <a href="medicos.html" class="nav-link">
                        <i class="fas fa-user-md"></i>
                        <span>M√©dicos</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Configura√ß√µes</span>
                    </a>
                </li>
            </ul>
            <hr>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                    id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="img/transferir.jpg" alt="User" width="32" height="32" class="rounded-circle me-2">
                    <strong>Paciente</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="#">Perfil</a></li>
                    <li><a class="dropdown-item" href="#">Configura√ß√µes</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="#">Sair</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Cabe√ßalho -->

        <!-- Se√ß√£o de Modalidades -->
        <section class="beneficios-section">
            <div class="container">
                <div class="row text-center mb-5">
                    <div class="col-12">
                        <h2 class="fw-bold">Escolha a modalidade que melhor atende suas necessidades</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="modalidade-card" id="modalidade-online">
                            <div class="modalidade-icon">
                                <i class="fas fa-laptop-medical"></i>
                            </div>
                            <h3>Consulta Online</h3>
                            <p>Atendimento por videochamada no conforto da sua casa, com a mesma qualidade de uma
                                consulta presencial.</p>
                            <ul class="list-unstyled text-start mt-3">
                                <li><i class="fas fa-check text-success me-2"></i> Sem necessidade de deslocamento</li>
                                <li><i class="fas fa-check text-success me-2"></i> Hor√°rios mais flex√≠veis</li>
                                <li><i class="fas fa-check text-success me-2"></i> Atendimento r√°pido e eficiente</li>
                                <li><i class="fas fa-check text-success me-2"></i> Receitas e atestados digitais</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="modalidade-card" id="modalidade-presencial">
                            <div class="modalidade-icon">
                                <i class="fas fa-hospital-user"></i>
                            </div>
                            <h3>Consulta Presencial</h3>
                            <p>Atendimento tradicional em uma de nossas unidades, com toda a estrutura necess√°ria para
                                seu cuidado.</p>
                            <ul class="list-unstyled text-start mt-3">
                                <li><i class="fas fa-check text-success me-2"></i> Exames f√≠sicos quando necess√°rio</li>
                                <li><i class="fas fa-check text-success me-2"></i> Equipamentos m√©dicos dispon√≠veis</li>
                                <li><i class="fas fa-check text-success me-2"></i> Contato direto com o profissional
                                </li>
                                <li><i class="fas fa-check text-success me-2"></i> Atendimento humanizado</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Formul√°rio de Agendamento -->
        <section class="form-section" id="formulario-agendamento">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="form-container">
                            <h2 class="form-title">Preencha os dados para agendar sua consulta</h2>

                            <form id="agendamento-form">
                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <label for="nome" class="form-label">Nome Completo *</label>
                                        <input type="text" class="form-control" id="nome" required>
                                        <div class="invalid-feedback">Por favor, informe seu nome completo.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" required>
                                        <div class="invalid-feedback">Por favor, informe um email v√°lido.</div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <label for="telefone" class="form-label">Telefone *</label>
                                        <input type="tel" class="form-control" id="telefone" required>
                                        <div class="invalid-feedback">Por favor, informe seu telefone.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="tipo-consulta" class="form-label">Tipo de Consulta *</label>
                                        <select class="form-select" id="tipo-consulta" required>
                                            <option value="" selected disabled>Selecione o tipo</option>
                                            <option value="online">Consulta Online</option>
                                            <option value="presencial">Consulta Presencial</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione o tipo de consulta.</div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <label for="especialidade" class="form-label">Especialidade *</label>
                                        <select class="form-select" id="especialidade" required>
                                            <option value="" selected disabled>Selecione a especialidade</option>
                                            <option value="cardiologia">Cardiologia</option>
                                            <option value="clinica-geral">Cl√≠nica Geral</option>
                                            <option value="dermatologia">Dermatologia</option>
                                            <option value="endocrinologia">Endocrinologia</option>
                                            <option value="ginecologia">Ginecologia</option>
                                            <option value="neurologia">Neurologia</option>
                                            <option value="odontologia">Odontologia</option>
                                            <option value="oftalmologia">Oftalmologia</option>
                                            <option value="ortopedia">Ortopedia</option>
                                            <option value="pediatria">Pediatria</option>
                                            <option value="psiquiatria">Psiquiatria</option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione uma especialidade.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="medico" class="form-label">M√©dico *</label>
                                        <select class="form-select" id="medico" required disabled>
                                            <option value="" selected disabled>Primeiro selecione a especialidade
                                            </option>
                                        </select>
                                        <div class="invalid-feedback">Por favor, selecione um m√©dico.</div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-12">
                                        <label class="form-label">Selecione a Data e Hor√°rio *</label>
                                        <div class="calendar-container mt-3">
                                            <div class="calendar-header">
                                                <button class="btn btn-sm btn-outline-secondary" id="prev-month"><i
                                                        class="fas fa-chevron-left"></i></button>
                                                <h5 id="current-month" class="mb-0">Junho 2025</h5>
                                                <button class="btn btn-sm btn-outline-secondary" id="next-month"><i
                                                        class="fas fa-chevron-right"></i></button>
                                            </div>

                                            <div class="calendar-grid">
                                                <div class="text-center fw-bold">Dom</div>
                                                <div class="text-center fw-bold">Seg</div>
                                                <div class="text-center fw-bold">Ter</div>
                                                <div class="text-center fw-bold">Qua</div>
                                                <div class="text-center fw-bold">Qui</div>
                                                <div class="text-center fw-bold">Sex</div>
                                                <div class="text-center fw-bold">S√°b</div>

                                                <!-- Dias do calend√°rio ser√£o preenchidos via JavaScript -->
                                            </div>

                                            <div class="time-slots mt-4" id="time-slots">
                                                <!-- Hor√°rios ser√£o preenchidos via JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="observacoes" class="form-label">Observa√ß√µes Adicionais</label>
                                    <textarea class="form-control" id="observacoes" rows="4"
                                        placeholder="Descreva brevemente o motivo da consulta ou alguma informa√ß√£o relevante..."></textarea>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-amarelo btn-lg">Agendar Consulta</button>
                                </div>

                                <div class="success-message" id="success-message">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Agendamento realizado com sucesso!</strong> Em breve voc√™ receber√° um email
                                    de
                                    confirma√ß√£o com todos os detalhes.
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Rodap√© -->
        <footer>
            <div class="container">
                <div class="row">
                    <div class="col-md-6 text-md-start text-center mb-3 mb-md-0">
                        <p class="mb-1">&copy; 2025 Sa√∫de Primeiro. Desenvolvido por Paulo J.</p>
                    </div>
                    <div class="col-md-6 text-md-end text-center">
                        <a href="#" class="me-3">Pol√≠tica de Privacidade</a>
                        <a href="#">Contato</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {

            // ==================== VARI√ÅVEIS GLOBAIS DE ESTADO ====================
            let allMedicos = []; // Armazena todos os m√©dicos carregados da API
            let selectedMedicoData = null; // Armazena o objeto do m√©dico selecionado no <select>
            let currentDate = new Date();
            let selectedDate = null;
            let selectedTime = null;

            // ==================== VERIFICA√á√ÉO DE AUTENTICA√á√ÉO ====================
            if (!api.isAuthenticated()) {
                console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado. Redirecionando para login...');
                window.location.href = 'login.html';
                return;
            }

            console.log('‚úÖ Usu√°rio autenticado:', api.getUser());

            // ==================== ELEMENTOS DO DOM ====================
            // Menu Lateral
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const menuToggle = document.querySelector('.menu-toggle');

            // Modalidades
            const modalidadeOnline = document.getElementById('modalidade-online');
            const modalidadePresencial = document.getElementById('modalidade-presencial');
            const tipoConsulta = document.getElementById('tipo-consulta');

            // Calend√°rio
            const currentMonthElement = document.getElementById('current-month');
            const calendarGrid = document.querySelector('.calendar-grid');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const timeSlotsContainer = document.getElementById('time-slots');

            // Formul√°rio
            const selectEspecialidade = document.getElementById('especialidade');
            const selectMedico = document.getElementById('medico');
            const agendamentoForm = document.getElementById('agendamento-form');
            const successMessage = document.getElementById('success-message');

            // ==================== FUN√á√ïES DE INTERFACE (Menu, Modalidade) ====================

            // Menu Lateral
            if (menuToggle) {
                menuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function () {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            }

            // Sele√ß√£o de modalidade
            if (modalidadeOnline && modalidadePresencial && tipoConsulta) {
                modalidadeOnline.addEventListener('click', function () {
                    modalidadeOnline.classList.add('selected');
                    modalidadePresencial.classList.remove('selected');
                    tipoConsulta.value = 'online';
                    console.log('‚úÖ Modalidade selecionada: Online');
                });

                modalidadePresencial.addEventListener('click', function () {
                    modalidadePresencial.classList.add('selected');
                    modalidadeOnline.classList.remove('selected');
                    tipoConsulta.value = 'presencial';
                    console.log('‚úÖ Modalidade selecionada: Presencial');
                });
            }

            // ==================== FUN√á√ïES DO CALEND√ÅRIO ====================

            // Renderizar calend√°rio
            function renderCalendar() {
                if (!currentMonthElement || !calendarGrid) {
                    console.error('‚ùå Elementos do calend√°rio n√£o encontrados');
                    return;
                }

                // Limpar hor√°rios ao mudar o m√™s
                clearTimeSlots();

                const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
                    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
                ];
                currentMonthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                calendarGrid.innerHTML = '';

                // Adicionar cabe√ßalhos dos dias
                dayNames.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'text-center fw-bold';
                    dayElement.textContent = day;
                    calendarGrid.appendChild(dayElement);
                });

                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const startingDayOfWeek = firstDay.getDay();

                // Adicionar dias do m√™s anterior (vazios)
                const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day disabled';
                    dayElement.textContent = prevMonthLastDay - i;
                    calendarGrid.appendChild(dayElement);
                }

                // Adicionar dias do m√™s atual
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Zera as horas para compara√ß√£o correta

                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = day;

                    const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    cellDate.setHours(0, 0, 0, 0);

                    // Marcar dia de hoje
                    if (cellDate.getTime() === today.getTime()) {
                        dayElement.classList.add('today');
                    }

                    // Desabilitar datas passadas
                    if (cellDate < today) {
                        dayElement.classList.add('disabled');
                        dayElement.title = 'Data passada';
                    }
                    // Desabilitar se m√©dico n√£o foi selecionado
                    else if (!selectedMedicoData) {
                        dayElement.classList.add('disabled');
                        dayElement.title = 'Selecione um m√©dico primeiro';
                    }
                    // Verificar disponibilidade do m√©dico
                    else {
                        const diaSemana = cellDate.getDay(); // 0 (Dom) a 6 (S√°b)
                        const disponibilidade = selectedMedicoData.disponibilidade || [];
                        const isAvailable = disponibilidade.some(d => d.diaSemana === diaSemana);

                        if (!isAvailable) {
                            dayElement.classList.add('disabled');
                            dayElement.title = 'M√©dico n√£o atende neste dia';
                        } else {
                            // Data v√°lida e dispon√≠vel - adicionar evento de clique
                            dayElement.classList.add('available');
                            dayElement.title = 'Clique para selecionar';
                            dayElement.addEventListener('click', function () {
                                selectDate(this, cellDate);
                            });
                        }
                    }

                    calendarGrid.appendChild(dayElement);
                }

                // Adicionar dias do pr√≥ximo m√™s (vazios)
                const totalCells = 42; // 6 semanas * 7 dias
                const remainingCells = totalCells - calendarGrid.children.length;
                for (let day = 1; day <= remainingCells; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day disabled';
                    dayElement.textContent = day;
                    calendarGrid.appendChild(dayElement);
                }

                console.log('üìÖ Calend√°rio renderizado para', monthNames[currentDate.getMonth()], currentDate.getFullYear());
            }

            // Inicializar calend√°rio e navega√ß√£o
            function initCalendar() {
                renderCalendar();

                if (prevMonthButton) {
                    prevMonthButton.addEventListener('click', function (e) {
                        e.preventDefault();
                        currentDate.setMonth(currentDate.getMonth() - 1);
                        renderCalendar();
                        console.log('‚¨ÖÔ∏è M√™s anterior');
                    });
                }

                if (nextMonthButton) {
                    nextMonthButton.addEventListener('click', function (e) {
                        e.preventDefault();
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        renderCalendar();
                        console.log('‚û°Ô∏è Pr√≥ximo m√™s');
                    });
                }
            }

            // Selecionar data
            function selectDate(element, date) {
                // Remover sele√ß√£o anterior
                const previouslySelected = document.querySelector('.calendar-day.selected');
                if (previouslySelected) {
                    previouslySelected.classList.remove('selected');
                }

                // Adicionar nova sele√ß√£o
                element.classList.add('selected');
                selectedDate = date;

                const dateString = date.toLocaleDateString('pt-BR');
                console.log('üìÖ Data selecionada:', dateString);

                // Carregar hor√°rios dispon√≠veis
                loadTimeSlots();
            }

            // Carregar hor√°rios dispon√≠veis baseados na disponibilidade real do m√©dico
            function loadTimeSlots() {
                if (!timeSlotsContainer) {
                    console.error('‚ùå Container de hor√°rios n√£o encontrado');
                    return;
                }

                clearTimeSlots();

                // Valida√ß√µes
                if (!selectedDate) {
                    timeSlotsContainer.innerHTML = '<p class="text-center text-muted">Selecione uma data primeiro.</p>';
                    return;
                }

                if (!selectedMedicoData) {
                    timeSlotsContainer.innerHTML = '<p class="text-center text-muted">Selecione o m√©dico e a data para ver os hor√°rios.</p>';
                    return;
                }

                // Encontrar disponibilidade do dia da semana (0=Dom, 6=S√°b)
                const diaSemana = selectedDate.getDay();
                const disponibilidade = selectedMedicoData.disponibilidade || [];
                const disponibilidadeDoDia = disponibilidade.find(d => d.diaSemana === diaSemana);

                if (!disponibilidadeDoDia || !disponibilidadeDoDia.horarios || disponibilidadeDoDia.horarios.length === 0) {
                    timeSlotsContainer.innerHTML = '<p class="text-center text-danger">Nenhum hor√°rio dispon√≠vel para esta data.</p>';
                    console.warn('‚ö†Ô∏è Nenhum hor√°rio dispon√≠vel para o dia da semana:', diaSemana);
                    return;
                }

                // Extrair e renderizar hor√°rios
                const timeSlots = disponibilidadeDoDia.horarios;
                console.log('üïê Hor√°rios dispon√≠veis:', timeSlots);

                timeSlots.forEach(time => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = time;
                    timeSlot.addEventListener('click', function () {
                        selectTime(this, time);
                    });
                    timeSlotsContainer.appendChild(timeSlot);
                });
            }

            // Selecionar hor√°rio
            function selectTime(element, time) {
                // Remover sele√ß√£o anterior
                const previouslySelected = document.querySelector('.time-slot.selected');
                if (previouslySelected) {
                    previouslySelected.classList.remove('selected');
                }

                // Adicionar nova sele√ß√£o
                element.classList.add('selected');
                selectedTime = time;

                console.log('üïê Hor√°rio selecionado:', time);
            }

            // Limpar hor√°rios
            function clearTimeSlots() {
                if (timeSlotsContainer) {
                    timeSlotsContainer.innerHTML = '';
                    selectedTime = null;
                }
            }

            // ==================== CARREGAMENTO INICIAL DE DADOS ====================

            // Inicializar o calend√°rio
            initCalendar();

            // Carregar m√©dicos e especialidades
            try {
                console.log('üîÑ Carregando m√©dicos da API...');
                allMedicos = await api.listarMedicos();
                console.log('‚úÖ M√©dicos carregados:', allMedicos.length);

                if (!allMedicos || allMedicos.length === 0) {
                    console.error('‚ùå Nenhum m√©dico encontrado no sistema');
                    alert('Nenhum m√©dico dispon√≠vel no momento. Tente novamente mais tarde.');
                    return;
                }

                // Extrair especialidades √∫nicas
                const especialidades = [...new Set(allMedicos.map(m => m.especialidade))].filter(Boolean);
                console.log('‚úÖ Especialidades dispon√≠veis:', especialidades);

                // Preencher select de especialidades
                if (selectEspecialidade) {
                    selectEspecialidade.innerHTML = '<option value="" selected disabled>Selecione a especialidade</option>';

                    especialidades.forEach(especialidade => {
                        const option = document.createElement('option');
                        option.value = especialidade;
                        option.textContent = especialidade;
                        selectEspecialidade.appendChild(option);
                    });

                    // Evento: quando especialidade mudar
                    selectEspecialidade.addEventListener('change', function () {
                        const especialidadeSelecionada = this.value;
                        console.log('üîç Especialidade selecionada:', especialidadeSelecionada);

                        // Filtrar m√©dicos pela especialidade
                        const medicosFiltrados = allMedicos.filter(m => m.especialidade === especialidadeSelecionada);
                        console.log('üë®‚Äç‚öïÔ∏è M√©dicos filtrados:', medicosFiltrados.length);

                        // Resetar select de m√©dicos
                        selectMedico.innerHTML = '<option value="" selected disabled>Selecione o m√©dico</option>';
                        selectedMedicoData = null;
                        renderCalendar(); // Recarrega calend√°rio (todos os dias desabilitados)

                        // Preencher m√©dicos filtrados
                        medicosFiltrados.forEach(medico => {
                            const option = document.createElement('option');
                            option.value = medico._id;
                            option.textContent = medico.usuario?.nome || 'Nome n√£o dispon√≠vel';
                            selectMedico.appendChild(option);
                        });

                        selectMedico.disabled = false;
                    });
                }

                // Evento: quando m√©dico mudar
                if (selectMedico) {
                    selectMedico.addEventListener('change', function () {
                        const medicoId = this.value;

                        // Encontrar objeto completo do m√©dico
                        selectedMedicoData = allMedicos.find(m => m._id === medicoId);

                        if (selectedMedicoData) {
                            console.log('üë®‚Äç‚öïÔ∏è M√©dico selecionado:', selectedMedicoData.usuario?.nome);
                            console.log('üìã Disponibilidade:', selectedMedicoData.disponibilidade);

                            // Recarregar calend√°rio para habilitar/desabilitar dias
                            renderCalendar();
                        } else {
                            console.error('‚ùå M√©dico n√£o encontrado:', medicoId);
                        }
                    });
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar m√©dicos:', error);
                alert('Erro ao carregar lista de m√©dicos: ' + error.message);
            }

            // Preencher dados do usu√°rio logado
            const user = api.getUser();
            if (user) {
                console.log('üë§ Preenchendo dados do usu√°rio:', user.nome);

                const nomeInput = document.getElementById('nome');
                const emailInput = document.getElementById('email');
                const telefoneInput = document.getElementById('telefone');

                if (nomeInput) nomeInput.value = user.nome || '';
                if (emailInput) emailInput.value = user.email || '';
                if (telefoneInput && user.telefone) telefoneInput.value = user.telefone;
            }

            // ==================== SUBMISS√ÉO DO FORMUL√ÅRIO ====================

            if (agendamentoForm) {
                agendamentoForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    console.log('üìù Submetendo formul√°rio de agendamento...');

                    // Valida√ß√£o: Data e Hor√°rio
                    if (!selectedDate || !selectedTime) {
                        alert('‚ùå Por favor, selecione uma data e hor√°rio para a consulta.');
                        console.error('‚ùå Data ou hor√°rio n√£o selecionados');
                        return;
                    }

                    // Valida√ß√£o: M√©dico
                    const medicoId = selectMedico?.value;
                    if (!medicoId || medicoId === '') {
                        alert('‚ùå Por favor, selecione um m√©dico.');
                        console.error('‚ùå M√©dico n√£o selecionado');
                        return;
                    }

                    // Valida√ß√£o: Tipo de Consulta
                    const tipo = tipoConsulta?.value;
                    if (!tipo || tipo === '') {
                        alert('‚ùå Por favor, selecione o tipo de consulta (Online ou Presencial).');
                        console.error('‚ùå Tipo de consulta n√£o selecionado');
                        return;
                    }

                    // Valida√ß√£o: Especialidade
                    const especialidade = selectEspecialidade?.value;
                    if (!especialidade || especialidade === '') {
                        alert('‚ùå Por favor, selecione uma especialidade.');
                        console.error('‚ùå Especialidade n√£o selecionada');
                        return;
                    }

                    // Coletar observa√ß√µes (opcional)
                    const observacoes = document.getElementById('observacoes')?.value || '';

                    // Formatar data para ISO (YYYY-MM-DD)
                    const dataFormatada = selectedDate.toISOString().split('T')[0];

                    // Montar objeto da consulta
                    const consulta = {
                        medicoId: medicoId,
                        data: dataFormatada,
                        horario: selectedTime,
                        tipo: tipo,
                        especialidade: especialidade,
                        observacoes: observacoes
                    };

                    console.log('üì§ Enviando consulta:', consulta);

                    try {
                        // Enviar para API
                        const resultado = await api.criarConsulta(consulta);
                        console.log('‚úÖ Consulta agendada com sucesso:', resultado);

                        // Mostrar mensagem de sucesso
                        if (successMessage) {
                            successMessage.style.display = 'block';
                            successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                            // Ocultar ap√≥s 8 segundos
                            setTimeout(() => {
                                successMessage.style.display = 'none';
                            }, 8000);
                        }

                        // Resetar formul√°rio
                        agendamentoForm.reset();

                        // Limpar sele√ß√µes visuais
                        document.querySelectorAll('.calendar-day.selected, .time-slot.selected').forEach(el => {
                            el.classList.remove('selected');
                        });

                        document.querySelectorAll('.modalidade-card.selected').forEach(el => {
                            el.classList.remove('selected');
                        });

                        // Resetar vari√°veis de estado
                        selectedDate = null;
                        selectedTime = null;
                        selectedMedicoData = null;
                        clearTimeSlots();

                        // Desabilitar select de m√©dico novamente
                        if (selectMedico) {
                            selectMedico.disabled = true;
                            selectMedico.innerHTML = '<option value="" selected disabled>Primeiro selecione a especialidade</option>';
                        }

                        // Recarregar calend√°rio (todos os dias desabilitados)
                        renderCalendar();

                        // Opcional: Mostrar modal ou redirecionar
                        // setTimeout(() => {
                        //     window.location.href = 'dashboard.html';
                        // }, 3000);

                    } catch (error) {
                        console.error('‚ùå Erro ao agendar consulta:', error);
                        alert('‚ùå Erro ao agendar consulta: ' + error.message);
                    }
                });
            }

            console.log('‚úÖ Script de agendamento carregado com sucesso');
        });
    </script>
</body>

</html>